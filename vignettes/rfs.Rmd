---
title: "The residual-fit spread plot"
author: "Manuel Gimond"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: TRUE
    css: style.css
vignette: >
  %\VignetteIndexEntry{The residual-fit spread plot}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#> ",
  message = FALSE,
  tidy = FALSE,
  cache = FALSE,
  warning = FALSE,
  encoding = "UTF-8"
)
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev.args=list(pointsize=10))
```

```{css echo = FALSE}
.caption {
    text-align: center !important;
    color: darkgrey;
    font-style: italic;
}
```


# Introduction

The *residual-fit spread plot* (rfs plot) is a plot first introduced by William Cleveland designed to compare the variability explained by a fitted model (such as group means for a univariate analysis or a linear model for a bivariate analysis) and the variability in the residuals. It's constructed as follows:

-  A model is fitted to the data.
-  The residuals are computed by subtracting the fitted values from the original values.
-  The estimated values from the model are centered on zero by subtracting, for example, the mean from the values.
-  The centered fitted values and residuals are each sorted from smallest to largest values.
-  Side-by-side plots are created by plotting the sorted fitted values and residuals to their respective f-values (i.e. their fractional contribution) 

Let's start with a simple dataset where a batch of sixty observations. 

```{r fig.height=2.8, fig.width=2.4, echo = FALSE, fig.cap="Figure 1. A batch of 60 values with the mean value represented as a red point. The points are jittered about the x-axis to help visualize their distribution.", fig.align="center"}
library(tukeyedar)

set.seed(9591)
df <- data.frame(y = rnorm(60, mean = c(10,11, 12), sd = 0.5), 
                 group = rep(c("a","b","c"), times = 20))

df.all <- df; df.all$group = " "
eda_boxls(df.all, y, group, fill = "white", outcol = "white", xlab = "All values",
          whiskcol = "white" , show.par = FALSE, medcol = "white", outlier = FALSE)
OP <- par(mar = c(0, 0, 0, 0))
points(x= jitter(rep(1,60), amount = 0.05), 
       y = df.all$y, pch = 21, col = "grey50", bg = "grey80")
points(x=1, tapply(df.all$y,df.all$group, FUN = mean), cex=2, col = "red3", pch=16)
par(OP)
```

At best, we can estimate the expected value using some summary statistic such as the mean (red point in figure 1)--`r round(mean(df$y),2)` in this working example. This gives us quite a bit of variability in predicting `y` given that the noise in the data covers a range of around `r round(range(df$y),0)` or around `r round(diff(range(df$y)))` units.

If we want to improve our estimation of the value in `y`, we may want to add a grouping variable to the mix. In Figure 2, we see that the same set of values are now split across groups `a`, `b` and `c`. Doing so, in this example, seems to reduce the variability, or the "randomness" in our estimation of `y`, given that by knowing which group `y` falls into, we can come up with a more precise estimate of the value while reducing the uncertainty associated with that estimate.

```{r fig.height=3, fig.width=2.3, echo = FALSE, fig.cap="Figure 2. Same batch of values split across three groups with each group's mean displayed as a red point.", fig.align="center"}
eda_boxls(df, y, group, fill = "white", outcol = "white", xlab = "All values",
          whiskcol = "white" , show.par = FALSE, medcol = "white", outlier = FALSE)
OP <- par(mar = c(0, 0, 0, 0))
points(x= jitter(rep(1:3,20), amount = 0.07), 
       y = df$y, pch = 21, col = "grey50", bg = "grey80")
points(x=1:3, tapply(df$y,df$group, FUN = mean), cex=2, col = "red3", pch=16)
par(OP)
```

Eyeballing the three batches, it seems that the residuals in the data are reduced down to around two units--an improvement in our estimation since there is less uncertainty in the estimated value if we know which group the value belongs to. 

The uncertainty seems consistent across all three batches, but note the outlier in batch `b` which may make it seem as though batch `b` has greater variability in its residuals. This brings up an issue as to how best to visualize the spread of the residuals in the data. In the above figures, we are jittering the points to help separate the observations, but this does not help us see how the residuals are distributed. In other words, are they uniformly distributed about the visible range of 2 units, or do they follow a bell shaped curve?  We could generated violin plots to help visualize the distributions as shown in Figure 3.

```{r fig.height=3.5, fig.width=4, echo = FALSE, fig.cap="Figure 3. Violin plots. Dashed lines show the mean values for each batch. The bisque colored inner region highlights where 50% of the residual values lie", fig.align="center", results='hide'}
eda_viol(df, y, group, stat = "mean", inner = 0.5, show.par = FALSE)
```

The bisque colored inner region in the Figure 3 violin plots highlight where 50% of the mid values lie in the distributions. The improvement in our ability to correctly estimate the mean values of $y$ increases by quite a bit when focusing on the inner 50% of residuals (2 units / 0.5 units = four fold difference in spreads between estimates and residuals).

Now, if we choose to focus on the inner 95% of the residuals, the difference in spreads between fitted values and residuals becomes a bit more modest as can be seen in Figure 4.

```{r fig.height=3.5, fig.width=4, echo = FALSE, fig.cap="Figure 4. Violin plots. The bisque colored inner region highlights where 95% of the residual values lie.", fig.align="center", results='hide'}
eda_viol(df, y, group, stat = "mean", inner = 0.95, show.par = FALSE)
```

Here, the residuals can span anywhere from 3 units (batch `a`) to 4 units (batch `b`). On average, we can say that the spread in residuals covers roughly 3.5 units. This makes the spread in fitted values about half of the spread in residuals when the latter is characterized as the mid 95% of residual values.

One can quickly see how our assessment of the value in adding a grouping variable to the data can be biased based on what mid portion of the residuals we should emphasize. For example, we probably don't want to focus on the full range since outliers may not be representative of the full dataset. Conversely, the mid 50% of residuals may be too restrictive. Ideally, we would want to have a plot that does not place emphasis on a single measure of spread when comparing spreads between fitted values and residuals. A Cleveland residual-fit spread plot (rfs for short) does away with this shortcoming. Key elements of the plot should include:

- Placing emphasis on the spreads of the fitted values and not their absolute values. This requires that the overall mean value be subtracted from the fitted values to center the latter around zero (this aligns the center of the fitted values with that of the residuals which are centered around zero by design).
- Order the fitted values and the residuals based on their respective ranks. This facilitates the comparison of a wide range of  measures of spreads such as the 50% or 95% spreads used in the earlier examples.

The above criteria can be satisfied by making use of side-by-side quantile plots where a quantile plot of the fitted values (minus the global mean) is paired up with a quantile plot of the residuals. The residual-fit spread plot for the working example is shown in figure 5.


```{r fig.height=3.5, fig.width=5, echo = FALSE, fig.cap="Figure 5. A residual-fit spread plot. Each observation is split between a quantile plot of fitted value minus group mean (left plot) and a quantile plot of residuals (right plot). To facilitate comparison between both plots, the mean values are centered on zero and the data are sorted giving use side-by-side quantile plots. The x-axis displays the fraction of values (f-value) in each plot that are at or below the matching value on the y-axis.", fig.align="center", results='hide'}
eda_rfs(df, y, group, show.par = FALSE)
```

What looks to be three horizontal lines on the left plot in Figure 5 are simply overlapping points--one point for each observation. Since an observation falls into one of the three groups, many observations will share the same fitted value. The rfs plot makes it easy to see that the spread in fitted mean values covers a range of 2 units on the y-axis. The right plot is constructed from the residuals for each observation (this is part of the observation value not explained by its fitted mean). 

For example, the last observation in the original dataset has a value of `11.05` and is part of group `c`. Its value can be decomposed into its group mean of 11.98 and its residual of '-0.93' as follows:

$$
11.05 = 11.98 - 0.93
$$
```{r fig.height=3.5, fig.width=2.8, echo = FALSE, fig.cap="Figure 6. Green point has a value of 11.05. It's decomposed into its group mean of 11.98 and its residual of -0.93. ", fig.align="center", results='hide'}
eda_boxls(df, y, group, fill = "white", outcol = "white", xlab = "All values",
          whiskcol = "white" , show.par = FALSE, medcol = "white", outlier = FALSE)
OP <- par(mar = c(0, 0, 0, 0))
set.seed(1111)
points(x= jitter(rep(1:3,20), amount = 0.07), 
       y = df$y, pch = 21, col = "grey50", bg = "grey80")
points(x=1:3, tapply(df$y,df$group, FUN = mean), cex=1.2, col = "red3", pch=16)
points(x=3, y=11.05, cex=1.5, col = "green3", pch=16)
par(OP)
```


That observation's mean and residual values are highlighted as green points in Figure 6.

```{r fig.height=3.5, fig.width=5, echo = FALSE, fig.cap="Figure 7. The  last observation is split between it fitted mean (centered on 0) and its residual. ", fig.align="center", results='hide'}
par1 <-  par()
eda_rfs(df, y, group, show.par = FALSE)
OP <- par(par1)
 points(x=0.495, y=0.85, col = "green3", pch = 16, cex = 1.5)
 points(x=0.55, y=0.17, col = "green3", pch = 16, cex = 1.5)
par(OP)
```

The same process is applied to all other observations resulting in the same number of points in both plots as total number of observations in the batch.

The rfs plot facilitates the comparison of both spreads by sharing the same y axis and by having both spreads centered on 0. In this working example, the spreads are about identical suggesting that the grouping variable can help explain some of the variability in the data.

To help develop an intuitive feel for the interpretation of the plot, we can explore two extreme scenarios. In this first scenario, we generate a dataset where much of the variability in the data can be explained by the fitted model. Figure 8 shows a plot of such a dataset. Note the tight spread in residuals around each fitted means.

```{r fig.height=2.8, fig.width=2.4, echo = FALSE, fig.cap="Figure 8. Another example.", fig.align="center"}
library(tukeyedar)
set.seed(9591)
df <- data.frame(y = rnorm(60, mean = c(10,11, 12), sd = 0.1), 
                 group = rep(c("a","b","c"), times = 20))

eda_boxls(df, y, group, fill = "white", outcol = "white", xlab = "All values",
          whiskcol = "white" , show.par = FALSE, medcol = "white", outlier = FALSE)
OP <- par(mar = c(0, 0, 0, 0))
points(x= jitter(rep(1:3,20), amount = 0.07), 
       y = df$y, pch = 21, col = "grey50", bg = "grey80")
points(x=1:3, tapply(df$y,df$group, FUN = mean), cex=2, col = "red3", pch=16)
par(OP)
```

Figure 9 shows the matching rfs plot.

```{r fig.height=3.5, fig.width=5, echo = FALSE, fig.cap="Figure 9. The spread in the fitted mean values spans 2 units along the y-axis. The residuals span less than 0.5 units suggesting that the fitted mean values do a good job in estimating the values in y.", fig.align="center", results='hide'}
eda_rfs(df, y, group, show.par = FALSE)
```

The groups do a really good job in predicting a value `y` if the observation's group is known since the error surrounding each group estimate is small relative to the spread or differences in the fitted mean values. In other words, an observation associated with a group is very unlikely to be confused with a value from another group given the large spread between group means versus the spread in the residuals or uncertainty surrounding an observation in each group.

In this next example, we look at the other extreme: one where the spread in fitted means is small relative to the uncertainty surrounding each fitted value:


```{r fig.height=2.8, fig.width=2.4, echo = FALSE, fig.cap="Figure 10. Another example.", fig.align="center"}
library(tukeyedar)
set.seed(511)
df <- data.frame(y = rnorm(60, mean = c(10,11, 12), sd = 3.2), 
                 group = rep(c("a","b","c"), times = 20))

eda_boxls(df, y, group, fill = "white", outcol = "white", xlab = "All values",
          whiskcol = "white" , show.par = FALSE, medcol = "white", outlier = FALSE)
OP <- par(mar = c(0, 0, 0, 0))
points(x= jitter(rep(1:3,20), amount = 0.07), 
       y = df$y, pch = 21, col = "grey50", bg = "grey80")
points(x=1:3, tapply(df$y,df$group, FUN = mean), cex=2, col = "red3", pch=16)
par(OP)
```

The rfs plot of the data is shown in Figure 11.

```{r fig.height=3.5, fig.width=5, echo = FALSE, fig.cap="Figure 11. ", fig.align="center", results='hide'}
eda_rfs(df, y, group, show.par = FALSE)
```

With this last dataset, the spread in residuals is quite important relative to the spread in fitted values. This suggests that the grouping variables do not have a large effect in predicting a value `y` given that the uncertainty in its value can make it comparable to another group's value.

## Generating an rfs plot with eda_rfs

The first dataset offered in the introduction can be recreated as follows:

```{r}
set.seed(9591)
df <- data.frame(y = rnorm(60, mean = c(10,11, 12), sd = 0.5), 
                 group = rep(c("a","b","c"), times = 20))
```

To generate an rfs plot, type:

```{r fig.height=3.5, fig.width=5, fig.cap="Figure 12. An rfs plot generated using the eda_rfs() function.", fig.align="center", results='hide'}
library(tukeyedar)

eda_rfs(df, y, group)
```

In addition to generating a plot, the function will also output some summary statistics of the spreads.

```{r fig.height=3.5, fig.width=5, echo = FALSE, fig.show='hide'}
eda_rfs(df, y, group)
```

By default, the function will focus on the inner 68.3% of the spread (what would be equivalent to a standard deviation if the residuals were normally distributed). You can view this region on the plot by setting the `q` parameter to `TRUE`.

```{r fig.height=3.5, fig.width=5, fig.cap="Figure 12. An rfs plot generated using the eda_rfs() function.", fig.align="center", results='hide'}
eda_rfs(df, y, group, q = TRUE)
```

The plot and the console output inidcate that about 68% of the residuals fall between -0.45 and +0.45, roughly. This econpasses a spread close to 1 unit. This is about twice the spread covered by the fitted values. 
